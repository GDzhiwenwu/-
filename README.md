## 背景
在游戏的互动场景中，任务系统是核心功能和关键玩法之一。任务旨在指导玩家达成目标并获得奖励。
![](https://cdn.nlark.com/yuque/0/2025/png/42512334/1748183620087-a62073f0-e774-48a8-8e29-799e5fe145d4.png)
<font style="color:rgb(64, 64, 64);">现有任务系统存在以下问题：</font>
1. <font style="color:rgb(64, 64, 64);">代码臃肿：单个类达数千行代码，方法长达数百行，代码负责且重复逻辑多</font>
2. <font style="color:rgb(64, 64, 64);">扩展性差：奖励机制仅支持1:1配置，多奖励需求需通过配置多条任务+前端聚合实现</font>
![](https://cdn.nlark.com/yuque/0/2025/png/42512334/1747751231338-f23a87d2-8603-4ed2-a7f1-2365d2e7a39f.png)
![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/42512334/1747751232582-0aa5fdb2-cca8-4a4e-a74b-0db21c061ce0.jpeg)
## 重构
### 重构目标
+ 丰富任务功能，支持进度任务（见下文《进度任务》）
+ 功能模块化，符合单一职责原则
+ 消除重复逻辑，降低代码复杂度
### 主要工作
+ 从上而下梳理游戏任务系统流程和功能点，根据任务职责（任务查询、领取、进度推进、奖励发奖等）拆分任务功能；
+ 通过引入门面模式，设计了一系列任务相关的高层接口，用于简化上游业务与任务系统之间的交互，有效地隐藏了任务系统的实现细节，降低了模块间的耦合度；
+ 利用线上真实流量进行重构回归测试，降低测试用例构造成本。遵循“空跑+白名单、灰度”的放量节奏，保障任务功能稳定
## 进度任务
### 定义
任务系统可按奖励发放机制分为**非进度任务**和**进度任务**，其中进度任务可进一步细分为**规则进度任务**和**非规则进度任务**。
#### 非进度任务（一次性任务）
+ 机制：仅在完全达成最终目标时发放奖励。
+ 本质：可视为进度任务的特例，其进度目标仅含最终完成值（0% → 100%）。
#### 进度任务（分阶段任务）
进度任务支持阶段性奖励发放，并可细分为两类：
（1）**规则进度任务**
+ 机制：阶段目标为固定数值，每完成固定进度 X 即发放固定奖励 Y。
+ 示例：每完成 20% 进度，发放金币×100（线性增长）。
（2）**非规则进度任务**
+ 机制：阶段目标由 多个自定义数值 组成，达到任意 Xi 即发放对应奖励 Yi。
+ 示例：进度达 30% 时发放道具A，达 80% 时发放皮肤B（非线性设计）。
![](https://cdn.nlark.com/yuque/0/2025/png/42512334/1747751231338-f23a87d2-8603-4ed2-a7f1-2365d2e7a39f.png)
<font style="color:rgb(44, 44, 54);">根据前述内容，非进度任务可视为进度任务的一个特例。因此，所有任务均可归类为进度驱动型任务，其通用行为模式遵循如下原则：“当进度值达到预设目标 Xi 时，触发相应奖励 Yi 的发放。”</font>
### 主要工作
#### <font style="color:rgb(23,23,23);">架构重构</font>
<font style="color:rgb(23,23,23);">解耦任务与奖励系统，设计1:N的关系模型，新增任务奖励配置表，通过任务id、进度类型、进度值三个字段确定唯一索引，实现步进任务动态扩展，支持上述的三种任务类型。</font>
#### <font style="color:rgb(23,23,23);">任务进度推进</font>
支持业务方使用同步调用、MetaQ异步的方式推进任务
#### <font style="color:rgb(23,23,23);">存储优化</font>
<font style="color:rgb(23,23,23);">引入比特位压缩技术，以二进制位列表记录奖励发放状态，单字段覆盖多奖励追踪；</font>
#### 高并发保障
<font style="color:rgb(23,23,23);">基于Redis分布式锁和幂等id实现重复领奖拦截；</font>
<font style="color:rgb(23,23,23);">结合Sping事务管理和自动重试机制，保障任务状态和奖励发放最终一致性</font>

